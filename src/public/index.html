<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LiteComics</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <style>
    /* ÂÖ±ÈÄö„Çπ„Çø„Ç§„É´ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
      color: #e0e0e0;
      line-height: 1.6;
      min-height: 100vh;
    }

    /* „Éï„Ç°„Ç§„É´‰∏ÄË¶ßÁîªÈù¢„ÅÆËÉåÊôØ */
    body.file-list {
      background: #1c1c1c;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    body.file-list[data-theme="light"] {
      background: #f5f5f7;
      color: #1d1d1f;
    }

    /* „Éï„Ç°„Ç§„É´‰∏ÄË¶ßÁîªÈù¢„ÅÆ„Çπ„Çø„Ç§„É´ */
    .container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
    }

    /* „Éë„É≥„Åè„Åö„É™„Çπ„Éà */
    .breadcrumb {
      margin: 0;
      padding: 8px 20px;
      background-color: #353535;
      border-bottom: 1px solid #3a3a3a;
      font-size: 1rem;
      color: #8e8e93;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 4px;
      height: 32px;
      flex-shrink: 0;
    }

    body[data-theme="light"] .breadcrumb {
      background-color: #ebebed;
      border-bottom: 1px solid #d1d1d6;
      color: #6e6e73;
    }

    .breadcrumb:empty {
      display: flex;
    }

    .menu-container {
      position: relative;
      margin-left: auto;
    }

    .menu-button {
      background: none;
      border: none;
      font-size: 1.3rem;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: background-color 0.2s;
      color: #e0e0e0;
    }

    body[data-theme="light"] .menu-button {
      color: #1d1d1f;
    }

    .menu-button:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    body[data-theme="light"] .menu-button:hover {
      background-color: rgba(0, 0, 0, 0.05);
    }

    .menu-popup {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 4px;
      background-color: #2d2d2d;
      border: 1px solid #3a3a3a;
      border-radius: 8px;
      padding: 8px;
      min-width: 120px;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    body[data-theme="light"] .menu-popup {
      background-color: #ffffff;
      border-color: #c7c7cc;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .menu-popup.visible {
      display: block;
    }

    .menu-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 4px;
      color: #e0e0e0;
      transition: background-color 0.2s;
    }

    body[data-theme="light"] .menu-item {
      color: #1d1d1f;
    }

    .menu-item:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    body[data-theme="light"] .menu-item:hover {
      background-color: rgba(0, 0, 0, 0.05);
    }

    .menu-item-label {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .menu-item-controls {
      display: flex;
      gap: 4px;
    }

    .menu-btn {
      background: none;
      border: 1px solid #666;
      color: #e0e0e0;
      font-size: 0.85rem;
      cursor: pointer;
      padding: 2px 8px;
      border-radius: 4px;
      transition: background-color 0.2s, border-color 0.2s;
      min-width: 28px;
    }

    body[data-theme="light"] .menu-btn {
      color: #1d1d1f;
      border-color: #c7c7cc;
    }

    .menu-btn:hover {
      background-color: rgba(255, 255, 255, 0.1);
      border-color: #999;
    }

    body[data-theme="light"] .menu-btn:hover {
      background-color: rgba(0, 0, 0, 0.05);
      border-color: #86868b;
    }

    .breadcrumb-item {
      color: #0a84ff;
      cursor: pointer;
      transition: color 0.15s;
      text-decoration: none;
      white-space: nowrap;
    }

    body[data-theme="light"] .breadcrumb-item {
      color: #007aff;
    }

    .breadcrumb-item:hover {
      color: #409cff;
    }

    .breadcrumb-home {
      font-size: 1.2rem;
      padding: 2px 0px;
    }

    .breadcrumb-current {
      color: #e0e0e0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    body[data-theme="light"] .breadcrumb-current {
      color: #1d1d1f;
    }

    .breadcrumb-separator {
      color: #666;
      user-select: none;
      white-space: nowrap;
    }

    body[data-theme="light"] .breadcrumb-separator {
      color: #86868b;
    }

    .file-list {
      background-color: #1c1c1c;
      border-radius: 0;
      padding: 0;
      margin: 0;
      overflow-y: auto;
      overflow-x: hidden;
      flex: 1;
      min-height: 0;
    }

    body[data-theme="light"] .file-list {
      background-color: #ffffff;
    }

    .list-section {
      margin: 0;
    }

    .tile-section {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 16px;
      padding: 16px 20px;
      background-color: #1c1c1c;
    }

    body[data-theme="light"] .tile-section {
      background-color: #ffffff;
    }

    .file-list-view {
      list-style: none;
      margin: 0;
      padding: 0;
    }

    .file-list-view li {
      padding: 5px 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .file-list-view li:nth-child(even) {
      background-color: #1c1c1c;
    }

    .file-list-view li:nth-child(odd) {
      background-color: #242424;
    }

    body[data-theme="light"] .file-list-view li:nth-child(even) {
      background-color: #ffffff;
    }

    body[data-theme="light"] .file-list-view li:nth-child(odd) {
      background-color: #fafafa;
    }

    .file-list-view li:hover:not(.selected) {
      background-color: #2d2d2d;
    }

    body[data-theme="light"] .file-list-view li:hover:not(.selected) {
      background-color: #e5e5ea;
    }

    .file-list-view li.selected {
      background-color: #0058d0;
      color: #fff;
      border-radius: 8px;
    }

    body[data-theme="light"] .file-list-view li.selected {
      background-color: #0058d0;
      color: #fff;
      border-radius: 8px;
    }

    .file-list-view li.selected a,
    .file-list-view li.selected span {
      color: #fff !important;
      font-weight: 400;
    }

    .file-list-view li::before {
      content: '';
      font-size: 1.2rem;
      min-width: 20px;
      width: 20px;
      text-align: center;
      flex-shrink: 0;
      display: inline-block;
      line-height: 1;
    }

    .file-list-view li.directory::before {
      content: 'üìÇ';
    }

    .file-list-view li.file::before {
      content: 'üìÉ';
    }

    .file-list-view li.video::before {
      content: 'üé¨';
    }

    .file-list-view li.audio::before {
      content: 'üéµ';
    }

    .file-list-view li.book::before {
      content: 'üìö';
    }

    .file-list-view li.image::before {
      content: 'üñºÔ∏è';
    }

    .file-list-view li.text::before {
      content: 'üìÑ';
    }

    .file-item-content {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
      overflow: hidden;
    }

    /* „Çø„Ç§„É´Ë°®Á§∫ */
    .tile-item {
      display: flex;
      flex-direction: column;
      cursor: pointer;
      overflow: hidden;
      transition: transform 0.2s, background-color 0.2s;
      background-color: #242424;
    }

    body[data-theme="light"] .tile-item {
      background-color: #f5f5f7;
    }

    .tile-item:hover {
      transform: translateY(-2px);
      background-color: #2d2d2d;
    }

    body[data-theme="light"] .tile-item:hover {
      background-color: #e5e5ea;
    }

    .tile-item.selected {
      background-color: #0058d0;
      transform: translateY(-2px);
    }

    body[data-theme="light"] .tile-item.selected {
      background-color: #0058d0;
    }

    .tile-item.selected .tile-title {
      color: #fff;
    }

    .tile-item a {
      text-decoration: none;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .tile-thumbnail {
      width: 100%;
      height: 240px;
      object-fit: contain;
      background-color: #1c1c1c;
    }

    body[data-theme="light"] .tile-thumbnail {
      background-color: #e0e0e0;
    }

    .tile-title {
      padding: 8px 2px;
      font-size: 1rem;
      color: #e0e0e0;
      line-height: 1.1;
      text-align: center;
      word-break: break-word;
    }

    body[data-theme="light"] .tile-title {
      color: #1d1d1f;
    }

    .file-list li a {
      color: #e0e0e0;
      text-decoration: none;
      display: block;
      font-size: 1rem;
      flex: 1;
      font-weight: 400;
      white-space: normal;
      overflow: hidden;
      word-break: break-word;
      line-height: 1.3;
    }

    body[data-theme="light"] .file-list li a {
      color: #1d1d1f;
    }

    .file-list .directory span {
      color: #e0e0e0;
      font-weight: 400;
      flex: 1;
      white-space: normal;
      overflow: hidden;
      word-break: break-word;
      line-height: 1.3;
    }

    body[data-theme="light"] .file-list .directory span {
      color: #1d1d1f;
    }

    .file-list .file span {
      color: #8e8e93;
      flex: 1;
      white-space: normal;
      overflow: hidden;
      word-break: break-word;
      line-height: 1.3;
    }

    body[data-theme="light"] .file-list .file span {
      color: #6e6e73;
    }

    .error {
      color: #ff6b6b;
      padding: 40px 20px;
      text-align: center;
      font-size: 1.1rem;
      background-color: rgba(255, 107, 107, 0.1);
      border-radius: 8px;
      border: 1px solid rgba(255, 107, 107, 0.3);
    }

    /* „Éó„É¨„Éì„É•„Éº„Ç™„Éº„Éê„Éº„É¨„Ç§ */
    #preview-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      z-index: 10000;
      align-items: center;
      justify-content: center;
    }

    #preview-overlay.visible {
      display: flex;
    }

    #preview-container {
      max-width: 90%;
      max-height: 90%;
      background: white;
      border-radius: 8px;
      overflow: auto;
      position: relative;
    }

    [data-theme="dark"] #preview-container {
      background: #2d2d2d;
      color: #e0e0e0;
    }

    #preview-close {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.9);
      border: none;
      color: #333;
      font-size: 24px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      z-index: 10001;
    }

    [data-theme="dark"] #preview-close {
      background: rgba(50, 50, 50, 0.9);
      color: #e0e0e0;
    }

    #preview-close:hover {
      background: rgba(255, 255, 255, 1);
    }

    [data-theme="dark"] #preview-close:hover {
      background: rgba(70, 70, 70, 1);
    }

    #preview-content {
      padding: 20px;
    }

    #preview-content img {
      max-width: 100%;
      height: auto;
      display: block;
    }

    #preview-content pre {
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: monospace;
      line-height: 1.5;
    }

    /* Â±•Ê≠¥„Ç™„Éº„Éê„Éº„É¨„Ç§ */
    #history-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      z-index: 10000;
      overflow-y: auto;
    }

    #history-overlay.visible {
      display: flex;
      flex-direction: column;
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 40px;
      background: rgba(28, 28, 28, 0.98);
      border-bottom: 2px solid #3a3a3a;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    body[data-theme="light"] .history-header {
      background: rgba(235, 235, 237, 0.98);
      border-bottom-color: #d1d1d6;
    }

    .history-header h2 {
      color: #fff;
      font-size: 1.5rem;
      font-weight: 600;
      margin: 0;
    }

    body[data-theme="light"] .history-header h2 {
      color: #1d1d1f;
    }

    .history-header-buttons {
      display: flex;
      gap: 12px;
    }

    .history-clear-btn {
      background: rgba(255, 59, 48, 0.9);
      border: none;
      color: #fff;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.95rem;
      transition: background 0.2s;
    }

    .history-clear-btn:hover {
      background: rgba(255, 59, 48, 1);
    }

    .history-close-btn {
      background: none;
      border: none;
      color: #fff;
      font-size: 2.5rem;
      cursor: pointer;
      padding: 0;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background 0.2s;
    }

    body[data-theme="light"] .history-close-btn {
      color: #1d1d1f;
    }

    .history-close-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    body[data-theme="light"] .history-close-btn:hover {
      background: rgba(0, 0, 0, 0.05);
    }

    .history-list {
      padding: 20px 40px;
      flex: 1;
    }

    .history-item {
      display: flex;
      align-items: stretch;
      gap: 12px;
      padding: 12px 16px;
      margin-bottom: 8px;
      background: #2a2a2a;
      border-radius: 8px;
      transition: background 0.2s, transform 0.2s;
      min-height: 60px;
    }

    body[data-theme="light"] .history-item {
      background: #f5f5f7;
    }

    .history-item-content {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 0;
      cursor: pointer;
      padding: 4px;
      margin: -4px;
      border-radius: 6px;
      transition: background 0.2s;
    }

    .history-item-content:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    body[data-theme="light"] .history-item-content:hover {
      background: rgba(0, 0, 0, 0.03);
    }

    .history-item-folder-btn {
      background: #4a4a4a;
      border: 1px solid #666;
      color: #fff;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
      white-space: nowrap;
      flex-shrink: 0;
      font-weight: 500;
      align-self: center;
    }

    body[data-theme="light"] .history-item-folder-btn {
      background: #e8e8e8;
      border-color: #c7c7cc;
      color: #1d1d1f;
    }

    .history-item-folder-btn:hover {
      background: #5a5a5a;
      border-color: #888;
      transform: translateY(-1px);
    }

    body[data-theme="light"] .history-item-folder-btn:hover {
      background: #d8d8d8;
      border-color: #86868b;
    }

    .history-item-icon {
      font-size: 1.5rem;
      flex-shrink: 0;
    }

    .history-item-info {
      flex: 1;
      min-width: 0;
    }

    .history-item-name {
      color: #e0e0e0;
      font-size: 1rem;
      font-weight: 500;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: normal;
      word-break: break-all;
      line-height: 1.2;
      margin-bottom: 4px;
    }

    body[data-theme="light"] .history-item-name {
      color: #1d1d1f;
    }

    .history-item-path {
      color: #8e8e93;
      font-size: 0.85rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: normal;
      word-break: break-all;
      line-height: 1.2;
    }

    body[data-theme="light"] .history-item-path {
      color: #6e6e73;
    }

    .history-item-time {
      color: #666;
      font-size: 0.8rem;
      flex-shrink: 0;
    }

    body[data-theme="light"] .history-item-time {
      color: #86868b;
    }

    .history-empty {
      text-align: center;
      color: #8e8e93;
      padding: 40px 20px;
      font-size: 1.1rem;
    }

    body[data-theme="light"] .history-empty {
      color: #6e6e73;
    }
  </style>
</head>

<body class="file-list">
  <div class="container">
    <div id="breadcrumb" class="breadcrumb">
      <div class="menu-container">
        <button id="menu-button" class="menu-button" title="Menu">‚ò∞</button>
        <div id="menu-popup" class="menu-popup">
          <div class="menu-item" id="menu-history">
            <div class="menu-item-label">
              <span>üïí</span>
              <span>History</span>
            </div>
          </div>
          <div class="menu-item" id="menu-theme">
            <div class="menu-item-label">
              <span id="theme-icon">üåì</span>
              <span>Theme</span>
            </div>
          </div>
          <div class="menu-item">
            <div class="menu-item-controls">
              <button id="font-size-decrease" class="menu-btn" title="Decrease (Ctrl + -)">A-</button>
              <button id="font-size-reset" class="menu-btn" title="Reset">A</button>
              <button id="font-size-increase" class="menu-btn" title="Increase (Ctrl + +)">A+</button>
            </div>
          </div>
          <div class="menu-item" id="menu-settings">
            <div class="menu-item-label">
              <span>‚öôÔ∏è</span>
              <span>Settings</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="file-list" class="file-list">
      <p>Loading...</p>
    </div>
  </div>

  <div id="preview-overlay">
    <button id="preview-close">√ó</button>
    <div id="preview-container">
      <div id="preview-content"></div>
    </div>
  </div>

  <div id="history-overlay">
    <div class="history-header">
      <h2>History</h2>
      <div class="history-header-buttons">
        <button id="history-clear" class="history-clear-btn">Clear All</button>
        <button id="history-close" class="history-close-btn">√ó</button>
      </div>
    </div>
    <div id="history-list" class="history-list"></div>
  </div>

  <script>
    let files = [];
    let currentIndex = 0;
    let currentRootName = null;
    let currentRelativePath = '';

    // Â±•Ê≠¥ÁÆ°ÁêÜ
    const MAX_HISTORY_ITEMS = 256;
    const HISTORY_KEY = 'file_history';

    // Â±•Ê≠¥„ÇíÂèñÂæó
    function getHistory() {
      try {
        const history = localStorage.getItem(HISTORY_KEY);
        return history ? JSON.parse(history) : [];
      } catch (e) {
        console.error('Failed to load history:', e);
        return [];
      }
    }

    // Â±•Ê≠¥„Çí‰øùÂ≠ò
    function saveHistory(history) {
      try {
        localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
      } catch (e) {
        console.error('Failed to save history:', e);
      }
    }

    // Â±•Ê≠¥„Å´ËøΩÂä†
    function addToHistory(file) {
      const history = getHistory();

      // Êó¢Â≠ò„ÅÆ„Ç®„É≥„Éà„É™„ÇíÂâäÈô§ÔºàÈáçË§á„ÇíÈÅø„Åë„ÇãÔºâ
      const filteredHistory = history.filter(h => h.path !== file.path);

      // Êñ∞„Åó„ÅÑ„Ç®„É≥„Éà„É™„ÇíÂÖàÈ†≠„Å´ËøΩÂä†
      const newEntry = {
        path: file.path,
        name: file.name,
        type: file.type,
        timestamp: Date.now()
      };

      filteredHistory.unshift(newEntry);

      // ÊúÄÂ§ßÊï∞„ÇíË∂Ö„Åà„ÅüÂàÜ„ÇíÂâäÈô§
      if (filteredHistory.length > MAX_HISTORY_ITEMS) {
        filteredHistory.splice(MAX_HISTORY_ITEMS);
      }

      saveHistory(filteredHistory);
    }

    // Â±•Ê≠¥„Çí„ÇØ„É™„Ç¢
    function clearHistory() {
      if (confirm('Are you sure you want to clear all history?')) {
        localStorage.removeItem(HISTORY_KEY);
        showHistoryOverlay();
      }
    }

    // Â±•Ê≠¥„Ç™„Éº„Éê„Éº„É¨„Ç§„ÇíË°®Á§∫
    function showHistoryOverlay() {
      const overlay = document.getElementById('history-overlay');
      const listDiv = document.getElementById('history-list');

      overlay.classList.add('visible');

      const history = getHistory();

      if (history.length === 0) {
        listDiv.innerHTML = '<div class="history-empty">No history yet</div>';
        return;
      }

      listDiv.innerHTML = '';

      history.forEach(item => {
        const historyItem = document.createElement('div');
        historyItem.className = 'history-item';

        // „Ç≥„É≥„ÉÜ„É≥„ÉÑ„Å∏„ÅÆ„É™„É≥„ÇØÈÉ®ÂàÜ
        const contentDiv = document.createElement('div');
        contentDiv.className = 'history-item-content';

        const icon = document.createElement('div');
        icon.className = 'history-item-icon';
        icon.textContent = item.type === 'book' ? 'üìö' : item.type === 'video' ? 'üé¨' : 'üéµ';

        const info = document.createElement('div');
        info.className = 'history-item-info';

        const name = document.createElement('div');
        name.className = 'history-item-name';
        name.textContent = item.name;

        const path = document.createElement('div');
        path.className = 'history-item-path';
        // „Éï„Ç°„Ç§„É´Âêç„ÇíÈô§„ÅÑ„Åü„Éá„Ç£„É¨„ÇØ„Éà„É™„Éë„Çπ„ÅÆ„ÅøË°®Á§∫
        const dirPath = item.path.substring(0, item.path.lastIndexOf('/'));
        path.textContent = dirPath || '/';

        info.appendChild(name);
        info.appendChild(path);

        const time = document.createElement('div');
        time.className = 'history-item-time';
        time.textContent = formatTime(item.timestamp);

        contentDiv.appendChild(icon);
        contentDiv.appendChild(info);
        contentDiv.appendChild(time);

        contentDiv.addEventListener('click', () => {
          if (item.type === 'book') {
            window.location.href = `/viewer/#${encodeURIComponent(item.path)}`;
          } else if (item.type === 'video' || item.type === 'audio') {
            window.location.href = `/media/#${encodeURIComponent(item.path)}`;
          }
        });

        // „Éï„Ç©„É´„ÉÄ„Éú„Çø„É≥
        const folderBtn = document.createElement('button');
        folderBtn.className = 'history-item-folder-btn';
        folderBtn.textContent = ' üìÅ ';
        folderBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          // „Éë„Çπ„Åã„ÇâË¶™„Éá„Ç£„É¨„ÇØ„Éà„É™„ÇíÂèñÂæó
          const parentPath = item.path.substring(0, item.path.lastIndexOf('/'));
          window.location.hash = `#${encodeURIComponent(parentPath)}`;
        });

        historyItem.appendChild(contentDiv);
        historyItem.appendChild(folderBtn);
        listDiv.appendChild(historyItem);
      });
    }

    // Â±•Ê≠¥„Ç™„Éº„Éê„Éº„É¨„Ç§„ÇíÈùûË°®Á§∫
    function hideHistoryOverlay() {
      const overlay = document.getElementById('history-overlay');
      overlay.classList.remove('visible');
    }

    // ÊôÇÂàª„Çí„Éï„Ç©„Éº„Éû„ÉÉ„Éà
    function formatTime(timestamp) {
      const now = Date.now();
      const diff = now - timestamp;

      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);

      if (minutes < 1) return 'Just now';
      if (minutes < 60) return `${minutes}m ago`;
      if (hours < 24) return `${hours}h ago`;
      if (days < 7) return `${days}d ago`;

      const date = new Date(timestamp);
      return date.toLocaleDateString();
    }

    // „Éï„Ç°„Ç§„É´Á®ÆÈ°û„ÅÆÂà§ÂÆö
    function isImageFile(filename) {
      const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp', '.avif'];
      const ext = filename.toLowerCase().split('.').pop();
      return imageExtensions.includes('.' + ext);
    }

    function isTextFile(filename) {
      const textExtensions = ['.txt', '.md', '.json', '.xml', '.log', '.csv', '.nfo'];
      const ext = filename.toLowerCase().split('.').pop();
      return textExtensions.includes('.' + ext);
    }

    function isPreviewableFile(filename) {
      return isImageFile(filename) || isTextFile(filename);
    }

    // „Éó„É¨„Éì„É•„ÉºË°®Á§∫
    async function showPreview(file) {
      const overlay = document.getElementById('preview-overlay');
      const content = document.getElementById('preview-content');

      content.innerHTML = '<p>Loading...</p>';
      overlay.classList.add('visible');

      try {
        const filePath = `/api/file/${encodeURIComponent(file.path)}`;

        if (isImageFile(file.name)) {
          const img = document.createElement('img');
          img.src = filePath;
          img.alt = file.name;
          content.innerHTML = '';
          content.appendChild(img);
        } else if (isTextFile(file.name)) {
          const response = await fetch(filePath);
          const text = await response.text();
          const pre = document.createElement('pre');
          pre.textContent = text;
          content.innerHTML = '';
          content.appendChild(pre);
        }
      } catch (err) {
        content.innerHTML = `<p>Error: ${err.message}</p>`;
      }
    }

    function hidePreview() {
      const overlay = document.getElementById('preview-overlay');
      overlay.classList.remove('visible');
    }

    // „Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫(zoom)„ÅÆÂàùÊúüÂåñ
    let zoomLevel = 100;

    function initZoom() {
      const savedZoom = localStorage.getItem('zoomLevel');
      if (savedZoom) {
        zoomLevel = parseInt(savedZoom);
      }
      applyZoom();
    }

    function applyZoom() {
      const container = document.querySelector('.container');
      if (container) {
        container.style.zoom = zoomLevel + '%';
      }
    }

    function changeZoom(delta) {
      zoomLevel = Math.max(50, Math.min(200, zoomLevel + delta));
      applyZoom();
      localStorage.setItem('zoomLevel', zoomLevel);
    }

    function resetZoom() {
      zoomLevel = 100;
      applyZoom();
      localStorage.setItem('zoomLevel', zoomLevel);
    }

    // „ÉÜ„Éº„Éû„ÅÆÂàùÊúüÂåñ
    function initTheme() {
      const savedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

      if (savedTheme) {
        document.body.setAttribute('data-theme', savedTheme);
      } else if (!prefersDark) {
        document.body.setAttribute('data-theme', 'light');
      }

      updateThemeIcon();
    }

    // „ÉÜ„Éº„Éû„Ç¢„Ç§„Ç≥„É≥„ÅÆÊõ¥Êñ∞
    function updateThemeIcon() {
      const theme = document.body.getAttribute('data-theme');
      const icon = document.getElementById('theme-icon');
      if (icon) {
        icon.textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
      }
    }

    // „ÉÜ„Éº„ÉûÂàá„ÇäÊõø„Åà
    function toggleTheme() {
      const currentTheme = document.body.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      document.body.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      updateThemeIcon();
    }

    // „É°„Éã„É•„Éº„ÅÆË°®Á§∫/ÈùûË°®Á§∫
    function toggleMenu() {
      const menu = document.getElementById('menu-popup');
      menu.classList.toggle('visible');
    }

    function hideMenu() {
      const menu = document.getElementById('menu-popup');
      menu.classList.remove('visible');
    }

    // „Éï„Ç°„Ç§„É´‰∏ÄË¶ß„ÇíÂèñÂæó„Åó„Å¶Ë°®Á§∫
    async function loadFileList(dirPath = null) {
      try {
        let response, data;

        if (dirPath) {
          response = await fetch(`/api/dir/${encodeURIComponent(dirPath)}`);
          data = await response.json();
          if (data.error) {
            throw new Error(data.error);
          }
          files = data.files;
          currentRootName = data.rootName;
          currentRelativePath = data.relativePath || '';
        } else {
          response = await fetch('/api/roots');
          files = await response.json();
          if (!Array.isArray(files)) {
            throw new Error(files.error || 'Failed to load roots');
          }
          currentRootName = null;
          currentRelativePath = '';
        }

        const fileListDiv = document.getElementById('file-list');
        fileListDiv.innerHTML = '';

        if (files.length === 0) {
          fileListDiv.innerHTML = '<p>No files found. Please check config.json.</p>';
          return;
        }

        // „Çø„Ç§„ÉóÂà•„Å´„Éï„Ç°„Ç§„É´„ÇíÂàÜÈ°û
        const filesByType = {
          directory: files.filter(f => f.type === 'directory'),
          book: files.filter(f => f.type === 'book'),
          video: files.filter(f => f.type === 'video'),
          audio: files.filter(f => f.type === 'audio'),
          file: files.filter(f => f.type === 'file')
        };

        // Ë°®Á§∫È†Ü„Å´‰∏¶„Åπ„ÅüÈÖçÂàó„Çí‰ΩúÊàêÔºà„Åì„Çå„Åå„Ç´„Éº„ÇΩ„É´ÁßªÂãï„ÅÆÈ†ÜÂ∫è„Å´„Å™„ÇãÔºâ
        files = [...filesByType.directory, ...filesByType.book, ...filesByType.video, ...filesByType.audio, ...filesByType.file];

        let displayIndex = 0;

        // „É™„Çπ„ÉàË°®Á§∫„ÅÆ„Éò„É´„Éë„ÉºÈñ¢Êï∞
        const createListSection = (fileList) => {
          if (fileList.length === 0) return;

          const section = document.createElement('div');
          section.className = 'list-section';
          const ul = document.createElement('ul');
          ul.className = 'file-list-view';

          fileList.forEach((file) => {
            ul.appendChild(createListItem(file, displayIndex++));
          });

          section.appendChild(ul);
          fileListDiv.appendChild(section);
        };

        // „Çø„Ç§„É´Ë°®Á§∫„ÅÆ„Éò„É´„Éë„ÉºÈñ¢Êï∞
        const createTileSection = (fileList) => {
          if (fileList.length === 0) return;

          const section = document.createElement('div');
          section.className = 'tile-section';

          fileList.forEach((file) => {
            section.appendChild(createTileItem(file, displayIndex++));
          });

          fileListDiv.appendChild(section);
        };

        // ÂêÑ„Çø„Ç§„Éó„ÅÆ„Éï„Ç°„Ç§„É´„ÇíË°®Á§∫
        createListSection(filesByType.directory);
        createTileSection(filesByType.book);
        createListSection(filesByType.video);
        createListSection(filesByType.audio);
        createListSection(filesByType.file);

        // „Éë„É≥„Åè„Åö„É™„Çπ„Éà„ÇíÊõ¥Êñ∞
        updateBreadcrumb();

        // „Ç´„Éº„ÇΩ„É´‰ΩçÁΩÆ„ÇíÂæ©ÂÖÉ
        // 1. sessionStorage„Åã„ÇâÔºà„Éì„É•„Éº„Ç¢„Åã„ÇâÊàª„Å£„Å¶„Åç„ÅüÂ†¥ÂêàÔºâ
        const savedIndexSession = sessionStorage.getItem('fileListIndex');
        const savedPathSession = sessionStorage.getItem('fileListPath');
        // 2. localStorage„Åã„ÇâÔºà„É™„É≠„Éº„Éâ„Åó„ÅüÂ†¥ÂêàÔºâ
        const storageKey = currentRootName ? `${currentRootName}/${currentRelativePath}` : '';
        const savedIndexLocal = localStorage.getItem(`fileList_index_${storageKey}`);

        if (savedIndexSession && savedPathSession === currentRelativePath) {
          currentIndex = parseInt(savedIndexSession);
          sessionStorage.removeItem('fileListIndex');
          sessionStorage.removeItem('fileListPath');
        } else if (savedIndexLocal !== null) {
          currentIndex = parseInt(savedIndexLocal);
        } else {
          currentIndex = 0;
        }

        updateSelection();
      } catch (err) {
        document.getElementById('file-list').innerHTML =
          `<p class="error">Error: ${err.message}</p>`;
      }
    }

    // „É™„Çπ„ÉàÂΩ¢Âºè„ÅÆ„Ç¢„Ç§„ÉÜ„É†„Çí‰ΩúÊàê
    function createListItem(file, index) {
      const li = document.createElement('li');

      // „ÇØ„É©„ÇπÂêç„ÇíË®≠ÂÆöÔºàCSS„Åß„Ç¢„Ç§„Ç≥„É≥„ÇíË°®Á§∫Ôºâ
      let className = file.type;
      if (file.type === 'file') {
        // „Éï„Ç°„Ç§„É´„Çø„Ç§„Éó„Çí„Åï„Çâ„Å´Á¥∞ÂàÜÂåñ
        if (isImageFile(file.name)) {
          className = 'image';
        } else if (isTextFile(file.name)) {
          className = 'text';
        }
      }
      li.className = className;
      li.dataset.index = index;

      const contentWrapper = document.createElement('div');
      contentWrapper.className = 'file-item-content';

      if (file.type === 'directory') {
        const link = document.createElement('a');
        link.href = `/#${encodeURIComponent(file.path)}`;
        link.textContent = file.name;
        contentWrapper.appendChild(link);
      } else if (file.type === 'video' || file.type === 'audio') {
        const link = document.createElement('a');
        link.href = `/media/#${encodeURIComponent(file.path)}`;
        link.textContent = file.name;
        link.addEventListener('click', (e) => {
          // „É™„É≥„ÇØ„ÇØ„É™„ÉÉ„ÇØÊôÇ„ÇÇsessionStorage„Å´‰øùÂ≠ò
          sessionStorage.setItem('fileListIndex', index);
          sessionStorage.setItem('fileListPath', currentRelativePath);
          // Â±•Ê≠¥„Å´ËøΩÂä†
          addToHistory(file);
        });
        contentWrapper.appendChild(link);
      } else if (isPreviewableFile(file.name)) {
        // „Éó„É¨„Éì„É•„ÉºÂèØËÉΩ„Å™„Éï„Ç°„Ç§„É´„ÇÇ„É™„É≥„ÇØ„Å®„Åó„Å¶Êâ±„ÅÜ
        const link = document.createElement('a');
        link.href = '#';
        link.textContent = file.name;
        link.addEventListener('click', (e) => {
          e.preventDefault();
          showPreview(file);
        });
        contentWrapper.appendChild(link);
      } else {
        // „Åù„ÅÆ‰ªñ„ÅÆ„Éï„Ç°„Ç§„É´„ÅØ„ÉÜ„Ç≠„Çπ„Éà„ÅÆ„ÅøË°®Á§∫Ôºà„Ç¢„Ç§„Ç≥„É≥„ÅØCSS„ÅßÔºâ
        const span = document.createElement('span');
        span.textContent = file.name;
        contentWrapper.appendChild(span);
      }

      li.appendChild(contentWrapper);

      li.addEventListener('click', (e) => {
        currentIndex = index;
        updateSelection(false);
        if (e.target.tagName !== 'A') {
          e.preventDefault();
        }
      });

      return li;
    }

    // „Çø„Ç§„É´ÂΩ¢Âºè„ÅÆ„Ç¢„Ç§„ÉÜ„É†„Çí‰ΩúÊàê
    function createTileItem(file, index) {
      const tile = document.createElement('div');
      tile.className = 'tile-item';
      tile.dataset.index = index;

      const link = document.createElement('a');
      link.href = `/viewer/#${encodeURIComponent(file.path)}`;

      const thumbnail = document.createElement('img');
      thumbnail.className = 'tile-thumbnail';
      thumbnail.src = `/api/book/${encodeURIComponent(file.path)}/thumbnail`;
      thumbnail.alt = file.name;
      thumbnail.loading = 'lazy';

      const title = document.createElement('div');
      title.className = 'tile-title';
      title.textContent = file.name;

      link.appendChild(thumbnail);
      link.appendChild(title);
      tile.appendChild(link);

      // „ÇØ„É™„ÉÉ„ÇØÊôÇ„Å´Â±•Ê≠¥„Å´ËøΩÂä†
      link.addEventListener('click', (e) => {
        addToHistory(file);
      });

      tile.addEventListener('click', (e) => {
        currentIndex = index;
        updateSelection(false);
      });

      return tile;
    }

    // „Éë„É≥„Åè„Åö„É™„Çπ„Éà„ÇíÊõ¥Êñ∞
    function updateBreadcrumb() {
      const breadcrumbDiv = document.getElementById('breadcrumb');
      const menuContainer = breadcrumbDiv.querySelector('.menu-container');

      breadcrumbDiv.innerHTML = '';

      const breadcrumbContent = document.createElement('div');
      breadcrumbContent.style.cssText = 'display:flex;align-items:center;gap:4px;flex:1;min-width:0;overflow:hidden';

      // „Éë„É≥„Åè„ÅöË¶ÅÁ¥†„Çí‰ΩúÊàê„Åô„Çã„Éò„É´„Éë„Éº
      const addItem = (text, href = null, isCurrent = false) => {
        const elem = document.createElement(href ? 'a' : 'span');
        elem.textContent = text;
        elem.className = isCurrent ? 'breadcrumb-current' : 'breadcrumb-item';
        if (href) elem.href = href;
        breadcrumbContent.appendChild(elem);
      };

      const addSeparator = () => {
        const sep = document.createElement('span');
        sep.className = 'breadcrumb-separator';
        sep.textContent = '‚Ä∫';
        breadcrumbContent.appendChild(sep);
      };

      // „Éõ„Éº„É†
      const homeLink = document.createElement('a');
      homeLink.textContent = 'üóÇÔ∏è';
      homeLink.className = 'breadcrumb-item breadcrumb-home';
      homeLink.href = '/';
      breadcrumbContent.appendChild(homeLink);

      if (currentRootName) {
        addSeparator();
        addItem(currentRootName, currentRelativePath ? `/#${encodeURIComponent(currentRootName)}` : null, !currentRelativePath);

        // Áõ∏ÂØæ„Éë„Çπ„ÅÆÂêÑÈöéÂ±§
        if (currentRelativePath) {
          const pathParts = currentRelativePath.split('/').filter(p => p);
          let accumulatedPath = currentRootName;

          pathParts.forEach((part, i) => {
            addSeparator();
            accumulatedPath += '/' + part;
            const isLast = i === pathParts.length - 1;
            addItem(part, isLast ? null : `/#${encodeURIComponent(accumulatedPath)}`, isLast);
          });
        }
      }

      breadcrumbDiv.appendChild(breadcrumbContent);
      breadcrumbDiv.appendChild(menuContainer);
    }

    // ÈÅ∏ÊäûÁä∂ÊÖã„ÇíÊõ¥Êñ∞
    function updateSelection(scroll = true) {
      const allItems = document.querySelectorAll('[data-index]');
      allItems.forEach((item) => {
        const index = parseInt(item.dataset.index);
        if (index === currentIndex) {
          item.classList.add('selected');
          if (scroll) {
            item.scrollIntoView({ block: 'center' });
          }
        } else {
          item.classList.remove('selected');
        }
      });

      // „Ç´„Éº„ÇΩ„É´‰ΩçÁΩÆ„ÇílocalStorage„Å´‰øùÂ≠ò
      const storageKey = currentRootName ? `${currentRootName}/${currentRelativePath}` : '';
      localStorage.setItem(`fileList_index_${storageKey}`, currentIndex);
    }

    // ÈÅ∏Êäû‰∏≠„ÅÆ„Ç¢„Ç§„ÉÜ„É†„ÇíÈñã„Åè
    function openSelected() {
      if (currentIndex < 0 || currentIndex >= files.length) return;
      document.querySelector(`[data-index="${currentIndex}"]`)?.querySelector('a')?.click();
    }

    // „Ç≠„Éº„Éú„Éº„Éâ„Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©
    document.addEventListener('keydown', async (e) => {
      switch (e.key) {
        case 'ArrowDown':
        case 'ArrowRight':
          e.preventDefault();
          if (currentIndex < files.length - 1) {
            currentIndex++;
            updateSelection();
          }
          break;
        case 'ArrowUp':
        case 'ArrowLeft':
          e.preventDefault();
          if (currentIndex > 0) {
            currentIndex--;
            updateSelection();
          }
          break;
        case 'PageDown':
          e.preventDefault();
          // 10‰ª∂‰∏ã„Å´ÁßªÂãï
          currentIndex = Math.min(currentIndex + 10, files.length - 1);
          updateSelection();
          break;
        case 'PageUp':
          e.preventDefault();
          // 10‰ª∂‰∏ä„Å´ÁßªÂãï
          currentIndex = Math.max(currentIndex - 10, 0);
          updateSelection();
          break;
        case 'Enter':
          e.preventDefault();
          openSelected();
          break;
        case 'Escape':
        case 'Backspace':
          e.preventDefault();
          // Â±•Ê≠¥„Ç™„Éº„Éê„Éº„É¨„Ç§„ÅåÈñã„ÅÑ„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÈñâ„Åò„Çã
          const historyOverlay = document.getElementById('history-overlay');
          if (historyOverlay.classList.contains('visible')) {
            hideHistoryOverlay();
            break;
          }
          // „Éó„É¨„Éì„É•„Éº„ÅåÈñã„ÅÑ„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÈñâ„Åò„Çã
          const overlay = document.getElementById('preview-overlay');
          if (overlay.classList.contains('visible')) {
            hidePreview();
            break;
          }
          // „É´„Éº„Éà„É¨„Éô„É´„Åß„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
          if (!currentRootName && !currentRelativePath) {
            break;
          }
          // localStorage„ÅÆ‰ΩçÁΩÆ„Çí„ÇØ„É™„Ç¢ÔºàÊàª„ÇãÊìç‰ΩúÊôÇÔºâ
          const storageKey = currentRootName ? `${currentRootName}/${currentRelativePath}` : '';
          localStorage.removeItem(`fileList_index_${storageKey}`);
          history.back();
          break;
      }
    });

    // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´„Éï„Ç°„Ç§„É´‰∏ÄË¶ß„ÇíÂèñÂæó
    initTheme();
    initZoom();

    document.getElementById('menu-button').addEventListener('click', (e) => {
      e.stopPropagation();
      toggleMenu();
    });
    document.getElementById('menu-history').addEventListener('click', () => {
      hideMenu();
      showHistoryOverlay();
    });
    document.getElementById('menu-settings').addEventListener('click', () => {
      hideMenu();
      window.location.href = '/settings.html';
    });
    document.getElementById('history-close').addEventListener('click', hideHistoryOverlay);
    document.getElementById('history-clear').addEventListener('click', clearHistory);
    document.getElementById('menu-theme').addEventListener('click', toggleTheme);
    document.getElementById('font-size-decrease').addEventListener('click', () => changeZoom(-10));
    document.getElementById('font-size-reset').addEventListener('click', resetZoom);
    document.getElementById('font-size-increase').addEventListener('click', () => changeZoom(10));
    document.getElementById('preview-close').addEventListener('click', hidePreview);
    document.getElementById('preview-overlay').addEventListener('click', (e) => {
      if (e.target.id === 'preview-overlay') {
        hidePreview();
      }
    });
    document.getElementById('history-overlay').addEventListener('click', (e) => {
      if (e.target.id === 'history-overlay') {
        hideHistoryOverlay();
      }
    });

    // „É°„Éã„É•„ÉºÂ§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
    document.addEventListener('click', (e) => {
      const menu = document.getElementById('menu-popup');
      const button = document.getElementById('menu-button');
      if (!menu.contains(e.target) && e.target !== button) {
        hideMenu();
      }
    });

    const hash = window.location.hash;
    const dirParam = hash ? decodeURIComponent(hash.substring(1)) : null;

    if (dirParam) {
      loadFileList(dirParam);
    } else {
      loadFileList(null);
    }

    // „Éè„ÉÉ„Ç∑„É•Â§âÊõ¥ÊôÇ„ÅÆÂá¶ÁêÜ
    window.addEventListener('hashchange', () => {
      const hash = window.location.hash;
      const dirParam = hash ? decodeURIComponent(hash.substring(1)) : null;
      if (dirParam) {
        loadFileList(dirParam);
      } else {
        loadFileList(null);
      }
    });
  </script>
</body>

</html>