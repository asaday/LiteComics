<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LiteComics</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <style>
    /* ÂÖ±ÈÄö„Çπ„Çø„Ç§„É´ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
      color: #e0e0e0;
      line-height: 1.6;
      min-height: 100vh;
    }

    /* „Éï„Ç°„Ç§„É´‰∏ÄË¶ßÁîªÈù¢„ÅÆËÉåÊôØ */
    body.file-list {
      background: #1c1c1c;
      margin: 0;
      padding: 0;
    }

    body.file-list[data-theme="light"] {
      background: #f5f5f7;
      color: #1d1d1f;
    }

    /* „Éï„Ç°„Ç§„É´‰∏ÄË¶ßÁîªÈù¢„ÅÆ„Çπ„Çø„Ç§„É´ */
    .container {
      max-width: 100%;
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* „Éë„É≥„Åè„Åö„É™„Çπ„Éà */
    .breadcrumb {
      margin: 0;
      padding: 8px 20px;
      background-color: #282828;
      border-bottom: 1px solid #3a3a3a;
      font-size: 0.85rem;
      color: #8e8e93;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 4px;
      height: 32px;
      flex-shrink: 0;
    }

    body[data-theme="light"] .breadcrumb {
      background-color: #ffffff;
      border-bottom: 1px solid #c7c7cc;
      color: #6e6e73;
    }

    .breadcrumb:empty {
      display: flex;
    }

    .theme-toggle {
      background: none;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: background-color 0.2s;
      margin-left: auto;
    }

    .theme-toggle:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    body[data-theme="light"] .theme-toggle:hover {
      background-color: rgba(0, 0, 0, 0.05);
    }

    .breadcrumb-item {
      color: #0a84ff;
      cursor: pointer;
      transition: color 0.15s;
      text-decoration: none;
      white-space: nowrap;
    }

    body[data-theme="light"] .breadcrumb-item {
      color: #007aff;
    }

    .breadcrumb-item:hover {
      color: #409cff;
    }

    .breadcrumb-current {
      color: #e0e0e0;
    }

    body[data-theme="light"] .breadcrumb-current {
      color: #1d1d1f;
    }

    .breadcrumb-separator {
      color: #666;
      user-select: none;
      white-space: nowrap;
    }

    body[data-theme="light"] .breadcrumb-separator {
      color: #86868b;
    }

    .file-list {
      background-color: #1c1c1c;
      border-radius: 0;
      padding: 0;
      margin: 0;
      overflow-y: auto;
      overflow-x: hidden;
      flex: 1;
    }

    body[data-theme="light"] .file-list {
      background-color: #ffffff;
    }

    .list-section {
      margin: 0;
    }

    .tile-section {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 16px;
      padding: 16px 20px;
      background-color: #1c1c1c;
    }

    body[data-theme="light"] .tile-section {
      background-color: #ffffff;
    }

    .file-list-view {
      list-style: none;
      margin: 0;
      padding: 0;
    }

    .file-list-view li {
      padding: 6px 20px;
      transition: background-color 0.1s ease;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      height: 32px;
    }

    .file-list-view li:nth-child(even) {
      background-color: #1c1c1c;
    }

    .file-list-view li:nth-child(odd) {
      background-color: #242424;
    }

    body[data-theme="light"] .file-list-view li:nth-child(even) {
      background-color: #ffffff;
    }

    body[data-theme="light"] .file-list-view li:nth-child(odd) {
      background-color: #fafafa;
    }

    .file-list-view li.selected {
      background-color: #0058d0;
      color: #fff;
      border-radius: 8px;
    }

    body[data-theme="light"] .file-list-view li.selected {
      background-color: #0058d0;
      color: #fff;
      border-radius: 8px;
    }

    .file-list-view li.selected a,
    .file-list-view li.selected span {
      color: #fff !important;
      font-weight: 400;
    }

    .file-list-view li::before {
      content: '';
      font-size: 1.4rem;
      width: 20px;
      text-align: center;
      flex-shrink: 0;
    }

    .file-list-view li.directory::before {
      content: 'üìÇ';
    }

    .file-list-view li.file::before {
      content: 'üìÉ';
    }

    .file-list-view li.media-file::before {
      content: '';
    }

    .file-item-content {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
      overflow: hidden;
    }

    /* „Çø„Ç§„É´Ë°®Á§∫ */
    .tile-item {
      display: flex;
      flex-direction: column;
      cursor: pointer;
      overflow: hidden;
      transition: transform 0.2s, background-color 0.2s;
      background-color: #242424;
    }

    body[data-theme="light"] .tile-item {
      background-color: #f5f5f7;
    }

    .tile-item:hover {
      transform: translateY(-2px);
      background-color: #2d2d2d;
    }

    body[data-theme="light"] .tile-item:hover {
      background-color: #e5e5ea;
    }

    .tile-item.selected {
      background-color: #0058d0;
      transform: translateY(-2px);
    }

    body[data-theme="light"] .tile-item.selected {
      background-color: #0058d0;
    }

    .tile-item.selected .tile-title {
      color: #fff;
    }

    .tile-item a {
      text-decoration: none;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .tile-thumbnail {
      width: 100%;
      height: 240px;
      object-fit: contain;
      background-color: #1c1c1c;
    }

    body[data-theme="light"] .tile-thumbnail {
      background-color: #e0e0e0;
    }

    .tile-title {
      padding: 8px;
      font-size: 0.75rem;
      color: #e0e0e0;
      line-height: 1.3;
      text-align: center;
      word-break: break-word;
    }

    body[data-theme="light"] .tile-title {
      color: #1d1d1f;
    }

    .file-list li a {
      color: #e0e0e0;
      text-decoration: none;
      display: block;
      font-size: 0.85rem;
      flex: 1;
      font-weight: 400;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    body[data-theme="light"] .file-list li a {
      color: #1d1d1f;
    }

    .file-list li a:hover {
      text-decoration: none;
    }

    .file-list .directory span {
      color: #e0e0e0;
      font-weight: 400;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    body[data-theme="light"] .file-list .directory span {
      color: #1d1d1f;
    }

    .file-list .file span {
      color: #8e8e93;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    body[data-theme="light"] .file-list .file span {
      color: #6e6e73;
    }

    .error {
      color: #ff6b6b;
      padding: 40px 20px;
      text-align: center;
      font-size: 1.1rem;
      background-color: rgba(255, 107, 107, 0.1);
      border-radius: 8px;
      border: 1px solid rgba(255, 107, 107, 0.3);
    }

    /* „Éó„É¨„Éì„É•„Éº„Ç™„Éº„Éê„Éº„É¨„Ç§ */
    #preview-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      z-index: 10000;
      align-items: center;
      justify-content: center;
    }

    #preview-overlay.visible {
      display: flex;
    }

    #preview-container {
      max-width: 90%;
      max-height: 90%;
      background: white;
      border-radius: 8px;
      overflow: auto;
      position: relative;
    }

    [data-theme="dark"] #preview-container {
      background: #2d2d2d;
      color: #e0e0e0;
    }

    #preview-close {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.9);
      border: none;
      color: #333;
      font-size: 24px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      z-index: 10001;
    }

    [data-theme="dark"] #preview-close {
      background: rgba(50, 50, 50, 0.9);
      color: #e0e0e0;
    }

    #preview-close:hover {
      background: rgba(255, 255, 255, 1);
    }

    [data-theme="dark"] #preview-close:hover {
      background: rgba(70, 70, 70, 1);
    }

    #preview-content {
      padding: 20px;
    }

    #preview-content img {
      max-width: 100%;
      height: auto;
      display: block;
    }

    #preview-content pre {
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: monospace;
      line-height: 1.5;
    }
  </style>
</head>
<body class="file-list">
  <div class="container">
    <div id="breadcrumb" class="breadcrumb">
      <button id="theme-toggle" class="theme-toggle" title="„ÉÜ„Éº„ÉûÂàá„ÇäÊõø„Åà">üåì</button>
    </div>
    <div id="file-list" class="file-list">
      <p>Ë™≠„ÅøËæº„Åø‰∏≠...</p>
    </div>
  </div>

  <div id="preview-overlay">
    <button id="preview-close">√ó</button>
    <div id="preview-container">
      <div id="preview-content"></div>
    </div>
  </div>

  <script>
    let files = [];
    let currentIndex = 0;
    let currentRootName = null;
    let currentRelativePath = '';

    // „Éï„Ç°„Ç§„É´Á®ÆÈ°û„ÅÆÂà§ÂÆö
    function isImageFile(filename) {
      const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp', '.avif'];
      const ext = filename.toLowerCase().split('.').pop();
      return imageExtensions.includes('.' + ext);
    }

    function isTextFile(filename) {
      const textExtensions = ['.txt', '.md', '.json', '.xml', '.log', '.csv', '.nfo'];
      const ext = filename.toLowerCase().split('.').pop();
      return textExtensions.includes('.' + ext);
    }

    function isPreviewableFile(filename) {
      return isImageFile(filename) || isTextFile(filename);
    }

    // „Éó„É¨„Éì„É•„ÉºË°®Á§∫
    async function showPreview(file) {
      const overlay = document.getElementById('preview-overlay');
      const content = document.getElementById('preview-content');
      
      content.innerHTML = '<p>Ë™≠„ÅøËæº„Åø‰∏≠...</p>';
      overlay.classList.add('visible');

      try {
        const filePath = `/api/file/${encodeURIComponent(file.path)}`;
        
        if (isImageFile(file.name)) {
          const img = document.createElement('img');
          img.src = filePath;
          img.alt = file.name;
          content.innerHTML = '';
          content.appendChild(img);
        } else if (isTextFile(file.name)) {
          const response = await fetch(filePath);
          const text = await response.text();
          const pre = document.createElement('pre');
          pre.textContent = text;
          content.innerHTML = '';
          content.appendChild(pre);
        }
      } catch (err) {
        content.innerHTML = `<p>„Ç®„É©„Éº: ${err.message}</p>`;
      }
    }

    function hidePreview() {
      const overlay = document.getElementById('preview-overlay');
      overlay.classList.remove('visible');
    }

    // „ÉÜ„Éº„Éû„ÅÆÂàùÊúüÂåñ
    function initTheme() {
      const savedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      
      if (savedTheme) {
        document.body.setAttribute('data-theme', savedTheme);
      } else if (!prefersDark) {
        document.body.setAttribute('data-theme', 'light');
      }
      
      updateThemeIcon();
    }

    // „ÉÜ„Éº„Éû„Ç¢„Ç§„Ç≥„É≥„ÅÆÊõ¥Êñ∞
    function updateThemeIcon() {
      const theme = document.body.getAttribute('data-theme');
      const toggle = document.getElementById('theme-toggle');
      if (toggle) {
        toggle.textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
      }
    }

    // „ÉÜ„Éº„ÉûÂàá„ÇäÊõø„Åà
    function toggleTheme() {
      const currentTheme = document.body.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      document.body.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      updateThemeIcon();
    }

    // „Éï„Ç°„Ç§„É´‰∏ÄË¶ß„ÇíÂèñÂæó„Åó„Å¶Ë°®Á§∫
    async function loadFileList(dirPath = null) {
      try {
        let response, data;
        
        if (dirPath) {
          response = await fetch(`/api/dir/${encodeURIComponent(dirPath)}`);
          data = await response.json();
          files = data.files;
          currentRootName = data.rootName;
          currentRelativePath = data.relativePath || '';
        } else {
          response = await fetch('/api/roots');
          files = await response.json();
          currentRootName = null;
          currentRelativePath = '';
        }
        
        const fileListDiv = document.getElementById('file-list');
        fileListDiv.innerHTML = '';
        
        if (files.length === 0) {
          fileListDiv.innerHTML = '<p>„Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇconfig.json„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>';
          return;
        }
        
        // „Éá„Ç£„É¨„ÇØ„Éà„É™„Å®„Éï„Ç°„Ç§„É´„ÇíÂàÜ„Åë„Å¶„ÄÅË°®Á§∫È†Ü„Å´‰∏¶„Åπ„Çã
        const directories = files.filter(f => f.isDirectory);
        const cbzFiles = files.filter(f => f.isArchive);
        const videoFiles = files.filter(f => f.isVideo);
        const audioFiles = files.filter(f => f.isAudio);
        const otherFiles = files.filter(f => !f.isDirectory && !f.isArchive && !f.isVideo && !f.isAudio);
        
        // Ë°®Á§∫È†Ü„Å´‰∏¶„Åπ„ÅüÈÖçÂàó„Çí‰ΩúÊàêÔºà„Åì„Çå„Åå„Ç´„Éº„ÇΩ„É´ÁßªÂãï„ÅÆÈ†ÜÂ∫è„Å´„Å™„ÇãÔºâ
        files = [...directories, ...cbzFiles, ...videoFiles, ...audioFiles, ...otherFiles];
        
        // „Éá„Ç£„É¨„ÇØ„Éà„É™„ÅÆ„É™„Çπ„ÉàË°®Á§∫
        let displayIndex = 0;
        
        if (directories.length > 0) {
          const dirSection = document.createElement('div');
          dirSection.className = 'list-section';
          
          const ul = document.createElement('ul');
          ul.className = 'file-list-view';
          
          directories.forEach((file) => {
            const li = createListItem(file, displayIndex);
            ul.appendChild(li);
            displayIndex++;
          });
          
          dirSection.appendChild(ul);
          fileListDiv.appendChild(dirSection);
        }
        
        // CBZ„Éï„Ç°„Ç§„É´„ÅÆ„Çø„Ç§„É´Ë°®Á§∫
        if (cbzFiles.length > 0) {
          const cbzSection = document.createElement('div');
          cbzSection.className = 'tile-section';
          
          cbzFiles.forEach((file) => {
            const tile = createTileItem(file, displayIndex);
            cbzSection.appendChild(tile);
            displayIndex++;
          });
          
          fileListDiv.appendChild(cbzSection);
        }
        
        // ÂãïÁîª„Éï„Ç°„Ç§„É´„ÅÆ„É™„Çπ„ÉàË°®Á§∫
        if (videoFiles.length > 0) {
          const videoSection = document.createElement('div');
          videoSection.className = 'list-section';
          
          const ul = document.createElement('ul');
          ul.className = 'file-list-view';
          
          videoFiles.forEach((file) => {
            const li = createListItem(file, displayIndex);
            ul.appendChild(li);
            displayIndex++;
          });
          
          videoSection.appendChild(ul);
          fileListDiv.appendChild(videoSection);
        }
        
        // Èü≥Â£∞„Éï„Ç°„Ç§„É´„ÅÆ„É™„Çπ„ÉàË°®Á§∫
        if (audioFiles.length > 0) {
          const audioSection = document.createElement('div');
          audioSection.className = 'list-section';
          
          const ul = document.createElement('ul');
          ul.className = 'file-list-view';
          
          audioFiles.forEach((file) => {
            const li = createListItem(file, displayIndex);
            ul.appendChild(li);
            displayIndex++;
          });
          
          audioSection.appendChild(ul);
          fileListDiv.appendChild(audioSection);
        }
        
        // „Åù„ÅÆ‰ªñ„ÅÆ„Éï„Ç°„Ç§„É´„ÅÆ„É™„Çπ„ÉàË°®Á§∫
        if (otherFiles.length > 0) {
          const otherSection = document.createElement('div');
          otherSection.className = 'list-section';
          
          const ul = document.createElement('ul');
          ul.className = 'file-list-view';
          
          otherFiles.forEach((file) => {
            const li = createListItem(file, displayIndex);
            ul.appendChild(li);
            displayIndex++;
          });
          
          otherSection.appendChild(ul);
          fileListDiv.appendChild(otherSection);
        }
        
        // „Éë„É≥„Åè„Åö„É™„Çπ„Éà„ÇíÊõ¥Êñ∞
        updateBreadcrumb();
        
        // „Ç´„Éº„ÇΩ„É´‰ΩçÁΩÆ„ÇíÂæ©ÂÖÉ
        // 1. sessionStorage„Åã„ÇâÔºà„Éì„É•„Éº„Ç¢„Åã„ÇâÊàª„Å£„Å¶„Åç„ÅüÂ†¥ÂêàÔºâ
        const savedIndexSession = sessionStorage.getItem('fileListIndex');
        const savedPathSession = sessionStorage.getItem('fileListPath');
        // 2. localStorage„Åã„ÇâÔºà„É™„É≠„Éº„Éâ„Åó„ÅüÂ†¥ÂêàÔºâ
        const storageKey = currentRootName ? `${currentRootName}/${currentRelativePath}` : '';
        const savedIndexLocal = localStorage.getItem(`fileList_index_${storageKey}`);
        
        if (savedIndexSession && savedPathSession === currentRelativePath) {
          currentIndex = parseInt(savedIndexSession);
          sessionStorage.removeItem('fileListIndex');
          sessionStorage.removeItem('fileListPath');
        } else if (savedIndexLocal !== null) {
          currentIndex = parseInt(savedIndexLocal);
        } else {
          currentIndex = 0;
        }
        
        updateSelection();
      } catch (err) {
        document.getElementById('file-list').innerHTML = 
          `<p class="error">„Ç®„É©„Éº: ${err.message}</p>`;
      }
    }

    // „É™„Çπ„ÉàÂΩ¢Âºè„ÅÆ„Ç¢„Ç§„ÉÜ„É†„Çí‰ΩúÊàê
    function createListItem(file, index) {
      const li = document.createElement('li');
      
      // „É°„Éá„Ç£„Ç¢„Éï„Ç°„Ç§„É´„ÅÆÂ†¥Âêà„ÅØ„ÇØ„É©„Çπ„ÇíÂ§âÊõ¥„Åó„Å¶„Éá„Éï„Ç©„É´„Éà„Ç¢„Ç§„Ç≥„É≥„ÇíÈùûË°®Á§∫
      if (file.isDirectory) {
        li.className = 'directory';
      } else if (file.isVideo || file.isAudio || file.isArchive || isImageFile(file.name) || isTextFile(file.name)) {
        li.className = 'media-file';
      } else {
        li.className = 'file';
      }
      
      li.dataset.index = index;
      
      const contentWrapper = document.createElement('div');
      contentWrapper.className = 'file-item-content';
      
      if (file.isDirectory) {
        const link = document.createElement('a');
        link.href = `/?dir=${encodeURIComponent(file.path)}`;
        link.textContent = file.name;
        contentWrapper.appendChild(link);
      } else if (file.isVideo) {
        const span = document.createElement('span');
        span.textContent = 'üé¨ ' + file.name;
        contentWrapper.appendChild(span);
      } else if (file.isAudio) {
        const span = document.createElement('span');
        span.textContent = 'üéµ ' + file.name;
        contentWrapper.appendChild(span);
      } else if (isImageFile(file.name)) {
        const span = document.createElement('span');
        span.textContent = 'üñºÔ∏è ' + file.name;
        contentWrapper.appendChild(span);
      } else if (isTextFile(file.name)) {
        const span = document.createElement('span');
        span.textContent = 'üìÑ ' + file.name;
        contentWrapper.appendChild(span);
      } else {
        const span = document.createElement('span');
        span.textContent = file.name;
        contentWrapper.appendChild(span);
      }
      
      li.appendChild(contentWrapper);
      
      li.addEventListener('click', (e) => {
        currentIndex = index;
        updateSelection(false);
        if (e.target.tagName !== 'A') {
          e.preventDefault();
        }
      });
      
      return li;
    }

    // „Çø„Ç§„É´ÂΩ¢Âºè„ÅÆ„Ç¢„Ç§„ÉÜ„É†„Çí‰ΩúÊàê
    function createTileItem(file, index) {
      const tile = document.createElement('div');
      tile.className = 'tile-item';
      tile.dataset.index = index;
      
      const link = document.createElement('a');
      link.href = `/viewer.html#/${encodeURIComponent(file.path)}`;
      
      const thumbnail = document.createElement('img');
      thumbnail.className = 'tile-thumbnail';
      thumbnail.src = `/api/archive/${encodeURIComponent(file.path)}/thumbnail`;
      thumbnail.alt = file.name;
      thumbnail.loading = 'lazy';
      
      const title = document.createElement('div');
      title.className = 'tile-title';
      title.textContent = file.name;
      
      link.appendChild(thumbnail);
      link.appendChild(title);
      tile.appendChild(link);
      
      tile.addEventListener('click', (e) => {
        currentIndex = index;
        updateSelection(false);
      });
      
      return tile;
    }

    // „Éë„É≥„Åè„Åö„É™„Çπ„Éà„ÇíÊõ¥Êñ∞
    function updateBreadcrumb() {
      const breadcrumbDiv = document.getElementById('breadcrumb');
      
      // „ÉÜ„Éº„Éû„Éà„Ç∞„É´„Éú„Çø„É≥„Çí‰øùÊåÅ
      const themeToggle = document.getElementById('theme-toggle');
      
      breadcrumbDiv.innerHTML = '';
      
      // „Éë„É≥„Åè„ÅöÈÉ®ÂàÜ„ÅÆ„Ç≥„É≥„ÉÜ„Éä
      const breadcrumbContent = document.createElement('div');
      breadcrumbContent.style.display = 'flex';
      breadcrumbContent.style.alignItems = 'center';
      breadcrumbContent.style.gap = '4px';
      breadcrumbContent.style.flex = '1';
      
      // „Éõ„Éº„É†„Ç¢„Ç§„Ç≥„É≥
      const home = document.createElement('a');
      home.href = '/';
      home.className = 'breadcrumb-item';
      home.textContent = 'Home';
      breadcrumbContent.appendChild(home);
      
      if (!currentRootName) {
        // „Éà„ÉÉ„Éó„É¨„Éô„É´„ÅÆÂ†¥Âêà„ÅØ„Éõ„Éº„É†„ÅÆ„Åø
        breadcrumbDiv.appendChild(breadcrumbContent);
        breadcrumbDiv.appendChild(themeToggle);
        return;
      }
      
      // „É´„Éº„ÉàÂêç„ÇíËøΩÂä†
      const separator1 = document.createElement('span');
      separator1.className = 'breadcrumb-separator';
      separator1.textContent = '‚Ä∫';
      breadcrumbContent.appendChild(separator1);
      
      if (!currentRelativePath) {
        // „É´„Éº„Éà„É¨„Éô„É´„ÅÆÂ†¥ÂêàÔºàÁèæÂú®Âú∞Ôºâ
        const rootCurrent = document.createElement('span');
        rootCurrent.className = 'breadcrumb-current';
        rootCurrent.textContent = currentRootName;
        breadcrumbContent.appendChild(rootCurrent);
      } else {
        // „É´„Éº„ÉàÂêçÔºà„ÇØ„É™„ÉÉ„ÇØÂèØËÉΩÔºâ
        const rootLink = document.createElement('a');
        rootLink.href = `/?dir=${encodeURIComponent(currentRootName)}`;
        rootLink.className = 'breadcrumb-item';
        rootLink.textContent = currentRootName;
        breadcrumbContent.appendChild(rootLink);
      }
      
      if (currentRelativePath) {
        // Áõ∏ÂØæ„Éë„Çπ„ÇíÂàÜÂâ≤„Åó„Å¶ÂêÑÈöéÂ±§„ÇíË°®Á§∫
        const pathParts = currentRelativePath.split('/').filter(p => p);
        let accumulatedPath = currentRootName;
        
        for (let i = 0; i < pathParts.length; i++) {
          const separator = document.createElement('span');
          separator.className = 'breadcrumb-separator';
          separator.textContent = '‚Ä∫';
          breadcrumbContent.appendChild(separator);
          
          accumulatedPath = accumulatedPath + '/' + pathParts[i];
          
          if (i === pathParts.length - 1) {
            // ÊúÄÂæå„ÅÆË¶ÅÁ¥†ÔºàÁèæÂú®„ÅÆ„Éï„Ç©„É´„ÉÄÔºâ
            const item = document.createElement('span');
            item.textContent = pathParts[i];
            item.className = 'breadcrumb-current';
            breadcrumbContent.appendChild(item);
          } else {
            // „ÇØ„É™„ÉÉ„ÇØÂèØËÉΩ„Å™Ë¶™„Éï„Ç©„É´„ÉÄ
            const item = document.createElement('a');
            item.href = `/?dir=${encodeURIComponent(accumulatedPath)}`;
            item.className = 'breadcrumb-item';
            item.textContent = pathParts[i];
            breadcrumbContent.appendChild(item);
          }
        }
      }
      
      breadcrumbDiv.appendChild(breadcrumbContent);
      breadcrumbDiv.appendChild(themeToggle);
    }

    // ÈÅ∏ÊäûÁä∂ÊÖã„ÇíÊõ¥Êñ∞
    function updateSelection(scroll = true) {
      const allItems = document.querySelectorAll('[data-index]');
      allItems.forEach((item) => {
        const index = parseInt(item.dataset.index);
        if (index === currentIndex) {
          item.classList.add('selected');
          if (scroll) {
            item.scrollIntoView({ block: 'center' });
          }
        } else {
          item.classList.remove('selected');
        }
      });
      
      // „Ç´„Éº„ÇΩ„É´‰ΩçÁΩÆ„ÇílocalStorage„Å´‰øùÂ≠ò
      const storageKey = currentRootName ? `${currentRootName}/${currentRelativePath}` : '';
      localStorage.setItem(`fileList_index_${storageKey}`, currentIndex);
    }

    // ÈÅ∏Êäû‰∏≠„ÅÆ„Ç¢„Ç§„ÉÜ„É†„ÇíÈñã„Åè
    function openSelected() {
      if (currentIndex < 0 || currentIndex >= files.length) return;
      
      const file = files[currentIndex];
      
      if (file.isArchive) {
        // „Ç´„Éº„ÇΩ„É´‰ΩçÁΩÆ„Å®ÁèæÂú®„ÅÆ„Éë„Çπ„Çí‰øùÂ≠ò
        sessionStorage.setItem('fileListIndex', currentIndex);
        sessionStorage.setItem('fileListPath', currentRelativePath);
        // „Ç¢„Éº„Ç´„Ç§„Éñ„Éï„Ç°„Ç§„É´„Çí„Éì„É•„Éº„Ç¢„ÅßÈñã„Åè
        window.location.href = `/viewer.html#/${encodeURIComponent(file.path)}`;
      } else if (file.isVideo || file.isAudio) {
        // „Ç´„Éº„ÇΩ„É´‰ΩçÁΩÆ„Å®ÁèæÂú®„ÅÆ„Éë„Çπ„Çí‰øùÂ≠ò
        sessionStorage.setItem('fileListIndex', currentIndex);
        sessionStorage.setItem('fileListPath', currentRelativePath);
        // „É°„Éá„Ç£„Ç¢„Éï„Ç°„Ç§„É´„Çí„Éó„É¨„Éº„É§„Éº„ÅßÈñã„Åè
        window.location.href = `/media.html#/${encodeURIComponent(file.path)}`;
      } else if (isPreviewableFile(file.name)) {
        // ÁîªÂÉè„Éª„ÉÜ„Ç≠„Çπ„Éà„Éï„Ç°„Ç§„É´„Çí„Éó„É¨„Éì„É•„Éº
        showPreview(file);
      } else if (file.isDirectory) {
        // „Éá„Ç£„É¨„ÇØ„Éà„É™„Å´ÂÖ•„Çã
        window.location.href = `/?dir=${encodeURIComponent(file.path)}`;
      }
    }

    // „Ç≠„Éº„Éú„Éº„Éâ„Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©
    document.addEventListener('keydown', async (e) => {
      switch(e.key) {
        case 'ArrowDown':
        case 'ArrowRight':
          e.preventDefault();
          if (currentIndex < files.length - 1) {
            currentIndex++;
            updateSelection();
          }
          break;
        case 'ArrowUp':
        case 'ArrowLeft':
          e.preventDefault();
          if (currentIndex > 0) {
            currentIndex--;
            updateSelection();
          }
          break;
        case 'PageDown':
          e.preventDefault();
          // 10‰ª∂‰∏ã„Å´ÁßªÂãï
          currentIndex = Math.min(currentIndex + 10, files.length - 1);
          updateSelection();
          break;
        case 'PageUp':
          e.preventDefault();
          // 10‰ª∂‰∏ä„Å´ÁßªÂãï
          currentIndex = Math.max(currentIndex - 10, 0);
          updateSelection();
          break;
        case 'Enter':
          e.preventDefault();
          openSelected();
          break;
        case 'Escape':
        case 'Backspace':
          e.preventDefault();
          // „Éó„É¨„Éì„É•„Éº„ÅåÈñã„ÅÑ„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÈñâ„Åò„Çã
          const overlay = document.getElementById('preview-overlay');
          if (overlay.classList.contains('visible')) {
            hidePreview();
            break;
          }
          // „É´„Éº„Éà„É¨„Éô„É´„Åß„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
          if (!currentRootName && !currentRelativePath) {
            break;
          }
          // localStorage„ÅÆ‰ΩçÁΩÆ„Çí„ÇØ„É™„Ç¢ÔºàÊàª„ÇãÊìç‰ΩúÊôÇÔºâ
          const storageKey = currentRootName ? `${currentRootName}/${currentRelativePath}` : '';
          localStorage.removeItem(`fileList_index_${storageKey}`);
          history.back();
          break;
      }
    });
    
    // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´„Éï„Ç°„Ç§„É´‰∏ÄË¶ß„ÇíÂèñÂæó
    initTheme();
    
    document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
    document.getElementById('preview-close').addEventListener('click', hidePreview);
    document.getElementById('preview-overlay').addEventListener('click', (e) => {
      if (e.target.id === 'preview-overlay') {
        hidePreview();
      }
    });
    
    const urlParams = new URLSearchParams(window.location.search);
    const dirParam = urlParams.get('dir');
    
    if (dirParam) {
      loadFileList(dirParam);
    } else {
      loadFileList(null);
    }
  </script>
</body>
</html>
