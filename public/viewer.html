<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LiteComics</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <style>
    /* 共通スタイル */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
      color: #e0e0e0;
      line-height: 1.6;
      min-height: 100vh;
    }

    /* ビューア画面の背景 */
    body.viewer {
      background: #000;
    }

    /* ローディングインジケータ */
    .loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .loading.hidden {
      display: none;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #333;
      border-top: 4px solid #4a9eff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .loading-text {
      color: #fff;
      margin-top: 20px;
      font-size: 1.2rem;
    }

    /* ビューア画面のスタイル */
    .viewer-body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: #000;
    }

    .viewer-container {
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }

    .image-display {
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
    }

    /* 1ページ表示 */
    .single-page {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 100%;
    }

    .single-page img {
      max-width: 100vw;
      max-height: 100vh;
      width: auto;
      height: auto;
      object-fit: contain;
    }

    /* 2ページ表示（見開き） */
    .double-page {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 100%;
      gap: 4px;
    }

    .page {
      display: flex;
      justify-content: center;
      align-items: center;
      max-width: 50vw;
      max-height: 100vh;
      flex: 0 1 auto;
    }

    .page img {
      max-width: 100%;
      max-height: 100vh;
      width: auto;
      height: auto;
      object-fit: contain;
      display: block;
    }

    /* ページ情報 */
    .page-info {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(0, 0, 0, 0.7);
      color: #fff;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9rem;
      z-index: 100;
      pointer-events: none;
      backdrop-filter: blur(5px);
      opacity: 1;
      transition: opacity 0.5s ease-in-out;
    }

    /* ツールバー */
    .toolbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background-color: rgba(0, 0, 0, 0.85);
      padding: 10px 20px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
      z-index: 200;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
      backdrop-filter: blur(15px);
      pointer-events: none;
      max-height: 90vh;
      overflow-y: auto;
    }

    .toolbar-buttons {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: center;
      width: 100%;
      max-width: 100%;
    }

    .toolbar-group {
      display: flex;
      gap: 4px;
      align-items: center;
      padding: 3px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      white-space: nowrap;
    }

    .filename-display {
      color: #fff;
      font-size: 0.85rem;
      text-align: center;
      line-height: 1.3;
      word-break: break-all;
      max-width: 90vw;
    }

    @media (max-width: 1200px) {
      .toolbar {
        padding: 8px 12px;
      }

      .toolbar-buttons {
        gap: 8px;
      }

      .toolbar-group {
        gap: 3px;
        padding: 2px;
      }
    }

    @media (max-width: 768px) {
      .toolbar {
        padding: 6px 8px;
      }

      .toolbar-buttons {
        gap: 6px;
      }

      .filename-display {
        font-size: 0.75rem;
      }
    }

    .toolbar.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .toolbar-btn {
      background: rgba(255, 255, 255, 0.12);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      white-space: nowrap;
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .toolbar-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.4);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
      transform: translateY(-1px);
    }

    .toolbar-btn:active {
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(0);
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
    }

    @media (max-width: 1200px) {
      .toolbar-btn {
        padding: 7px 12px;
        font-size: 0.8rem;
      }
    }

    @media (max-width: 768px) {
      .toolbar-btn {
        padding: 6px 10px;
        font-size: 0.75rem;
      }
    }

    /* ヘルプ画面 */
    .help {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .help-content {
      background-color: #2a2a2a;
      padding: 40px;
      border-radius: 12px;
      max-width: 600px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      text-align: left;
    }

    .help-content h3 {
      color: #fff;
      margin-bottom: 20px;
      font-size: 1.5rem;
      text-align: center;
    }

    .help-content ul {
      list-style: none;
      padding: 0;
    }

    .help-content li {
      padding: 10px 0;
      border-bottom: 1px solid #3a3a3a;
      font-size: 1.1rem;
    }

    .help-content li:last-child {
      border-bottom: none;
    }

    .help-content strong {
      color: #4a9eff;
      font-weight: 600;
      display: inline-block;
      min-width: 120px;
    }

    .help-hint {
      margin-top: 20px;
      text-align: center;
      color: #999;
      font-size: 0.9rem;
      font-style: italic;
    }

    .help-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .help-header h3 {
      margin: 0;
    }

    .close-help-btn {
      background: none;
      border: none;
      color: #fff;
      font-size: 2rem;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background 0.2s;
    }

    .close-help-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    /* レスポンシブ対応: ウィンドウリサイズ時も最適なサイズで表示 */
    @media (max-width: 768px) {
      .double-page {
        flex-direction: column;
      }

      .page {
        max-width: 100vw;
        max-height: 50vh;
      }

      .page img {
        max-height: 50vh;
      }
    }

    /* 全画面モード時のスタイル調整 */
    :fullscreen .viewer-container,
    :-webkit-full-screen .viewer-container,
    :-moz-full-screen .viewer-container {
      width: 100vw;
      height: 100vh;
    }

    /* ページ一覧サイドバー */
    .page-sidebar {
      position: fixed;
      left: -280px;
      top: 0;
      width: 280px;
      height: 100vh;
      background: rgba(28, 28, 28, 0.75);
      transition: left 0.3s ease;
      z-index: 1000;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.5);
      display: flex;
      flex-direction: column;
    }

    .page-sidebar.visible {
      left: 0;
    }

    .page-sidebar-content {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .page-sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 2px solid #3a3a3a;
      flex-shrink: 0;
    }

    .page-sidebar-title {
      color: #fff;
      font-size: 1.2rem;
      font-weight: 600;
    }

    .close-sidebar-btn {
      background: none;
      border: none;
      color: #fff;
      font-size: 2rem;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background 0.2s;
    }

    .close-sidebar-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .page-list {
      display: flex;
      flex-direction: column;
      gap: 2px;
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }

    .page-item {
      position: relative;
      cursor: pointer;
      padding: 10px 12px;
      border-radius: 6px;
      transition: background 0.2s, transform 0.2s;
      background: rgba(42, 42, 42, 0.1);
      display: flex;
      align-items: center;
      gap: 8px;
      color: #e0e0e0;
      font-size: 0.95rem;
    }

    .page-item:hover {
      background: rgba(58, 58, 58, 0.4);
      transform: translateX(5px);
    }

    .page-item.current {
      background: #4a9eff;
      color: #fff;
      font-weight: 600;
    }

    .page-number {
      color: #999;
      font-weight: 600;
      min-width: 35px;
    }

    .page-item.current .page-number {
      color: #fff;
    }

    .file-name {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* ページ一覧オーバーレイ */
    .page-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.95);
      z-index: 2000;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .page-overlay-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 40px;
      background: rgba(28, 28, 28, 0.98);
      border-bottom: 2px solid #3a3a3a;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .page-overlay-header h2 {
      color: #fff;
      font-size: 1.5rem;
      font-weight: 600;
      margin: 0;
    }

    .close-overlay-btn {
      background: none;
      border: none;
      color: #fff;
      font-size: 2.5rem;
      cursor: pointer;
      padding: 0;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background 0.2s;
    }

    .close-overlay-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .page-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      padding: 40px;
    }

    .page-grid-item {
      position: relative;
      cursor: pointer;
      border-radius: 8px;
      overflow: hidden;
      transition: transform 0.2s, box-shadow 0.2s;
      background: #2a2a2a;
      aspect-ratio: 3/4;
    }

    .page-grid-item:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 24px rgba(74, 158, 255, 0.4);
    }

    .page-grid-item.current {
      box-shadow: 0 0 0 4px #4a9eff;
    }

    .page-grid-thumbnail {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .page-grid-number {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 600;
    }

    .page-grid-item.current .page-grid-number {
      background: #4a9eff;
    }
  </style>
</head>

<body class="viewer viewer-body">
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <div class="loading-text">読み込み中...</div>
  </div>

  <div id="viewer-container" class="viewer-container">
    <div id="image-display" class="image-display">
    </div>
    <div id="page-info" class="page-info">読み込み中...</div>

    <!-- ツールバー -->
    <div id="toolbar" class="toolbar">
      <div id="filename-display" class="filename-display"></div>
      <div class="toolbar-buttons">
        <!-- ナビゲーション -->
        <div class="toolbar-group">
          <button id="btn-back" class="toolbar-btn" title="ファイル一覧に戻る (ESC)">✕ 閉じる</button>
        </div>
        <!-- ページ操作 -->
        <div class="toolbar-group">
          <button id="btn-next" class="toolbar-btn" title="次のページ (←)">◀◀</button>
          <button id="btn-offset-down" class="toolbar-btn" title="配置修正: 1ページ進む (↓)">◀</button>
          <button id="btn-offset-up" class="toolbar-btn" title="配置修正: 1ページ戻る (↑)">▶</button>
          <button id="btn-prev" class="toolbar-btn" title="前のページ (→)">▶▶</button>
        </div>
        <!-- ナビゲーション -->
        <div class="toolbar-group">
          <button id="btn-list" class="toolbar-btn" title="ファイル名リスト (L)">リスト</button>
          <button id="btn-thumbnails" class="toolbar-btn" title="サムネイル一覧 (T)">サムネイル</button>
        </div>
        <!-- 表示設定 -->
        <div class="toolbar-group">
          <button id="btn-single" class="toolbar-btn" title="単/複表示切り替え (S)">単/複</button>
          <button id="btn-fullscreen" class="toolbar-btn" title="全画面 (Enter)">全画面</button>
          <button id="btn-help" class="toolbar-btn" title="ヘルプ (H)">ヘルプ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ファイル一覧サイドバー -->
  <div id="page-sidebar" class="page-sidebar">
    <div class="page-sidebar-content">
      <div class="page-sidebar-header">
        <div class="page-sidebar-title">ファイル一覧</div>
        <button id="close-sidebar" class="close-sidebar-btn">×</button>
      </div>
      <div id="page-list" class="page-list"></div>
    </div>
  </div>

  <!-- ページ一覧オーバーレイ -->
  <div id="page-overlay" class="page-overlay" style="display: none;">
    <div class="page-overlay-header">
      <h2>ページ一覧</h2>
      <button id="close-overlay" class="close-overlay-btn">×</button>
    </div>
    <div id="page-grid" class="page-grid"></div>
  </div>

  <div id="help" class="help" style="display: none;">
    <div class="help-content">
      <div class="help-header">
        <h3>操作方法</h3>
        <button id="close-help" class="close-help-btn">×</button>
      </div>
      <ul>
        <li><strong>← / → / Space</strong>: ページ送り</li>
        <li><strong>↑ / ↓</strong>: 配置修正（１ページ進む/戻る）</li>
        <li><strong>Enter</strong>: 全画面モード切り替え</li>
        <li><strong>S</strong>: 単/複表示モード切り替え</li>
        <li><strong>T</strong>: サムネイル一覧を表示</li>
        <li><strong>L</strong>: ファイル名リストを表示</li>
        <li><strong>ESC / Backspace</strong>: ファイル一覧に戻る</li>
        <li><strong>H</strong>: このヘルプを表示/非表示</li>
      </ul>
      <p class="help-hint">Hキーまたは×ボタンで閉じる</p>
    </div>
  </div>

  <script>
    // ビューアの状態管理
    let currentFile = '';
    let images = [];
    let currentPage = 0; // 表示開始ページのインデックス
    let offset = 0; // 配置修正用のオフセット
    let imageCache = {}; // 画像のキャッシュ
    let forceSinglePageMode = false; // 強制1ページモード
    let pageInfoTimer = null; // ページ情報の自動非表示タイマー

    // ページ一覧サイドバーの表示/非表示
    let sidebarVisible = false;
    let sidebarTimer = null;

    function showPageSidebar() {
      const sidebar = document.getElementById('page-sidebar');
      if (sidebar) {
        sidebar.classList.add('visible');
        sidebarVisible = true;
      }
    }

    function hidePageSidebar() {
      const sidebar = document.getElementById('page-sidebar');
      if (sidebar) {
        sidebar.classList.remove('visible');
        sidebarVisible = false;
      }
    }

    function togglePageSidebar() {
      // 常に表示する（閉じるのは×ボタンのみ）
      showPageSidebar();
      generatePageList();
    }

    // ページ一覧を生成
    function generatePageList() {
      const pageList = document.getElementById('page-list');
      if (!pageList || images.length === 0) return;

      pageList.innerHTML = '';

      images.forEach((imageName, index) => {
        const pageItem = document.createElement('div');
        pageItem.className = 'page-item';
        if (index === currentPage) {
          pageItem.classList.add('current');
        }

        const pageNumber = document.createElement('span');
        pageNumber.className = 'page-number';
        pageNumber.textContent = `${index + 1}. `;

        const fileName = document.createElement('span');
        fileName.className = 'file-name';
        fileName.textContent = imageName.split('/').pop(); // ファイル名のみ表示

        pageItem.appendChild(pageNumber);
        pageItem.appendChild(fileName);

        pageItem.addEventListener('click', () => {
          currentPage = index;
          displayCurrentPages();
          // サイドバーは閉じない
        });

        pageList.appendChild(pageItem);
      });
    }

    // ページ一覧オーバーレイの表示/非表示
    function showPageOverlay() {
      const overlay = document.getElementById('page-overlay');
      if (overlay) {
        overlay.style.display = 'flex';
        generatePageGrid();
      }
    }

    function hidePageOverlay() {
      const overlay = document.getElementById('page-overlay');
      if (overlay) {
        overlay.style.display = 'none';
      }
    }

    // ページ一覧グリッドを生成
    function generatePageGrid() {
      const gridContainer = document.getElementById('page-grid');
      if (!gridContainer || images.length === 0) return;

      gridContainer.innerHTML = '';

      images.forEach((imageName, index) => {
        const gridItem = document.createElement('div');
        gridItem.className = 'page-grid-item';
        if (index === currentPage) {
          gridItem.classList.add('current');
        }

        const thumbnail = document.createElement('img');
        thumbnail.className = 'page-grid-thumbnail';
        thumbnail.src = `/api/book/${currentFile}/image/${index}`;
        thumbnail.alt = `Page ${index + 1}`;

        const pageNumber = document.createElement('div');
        pageNumber.className = 'page-grid-number';
        pageNumber.textContent = index + 1;

        gridItem.appendChild(thumbnail);
        gridItem.appendChild(pageNumber);

        gridItem.addEventListener('click', () => {
          currentPage = index;
          displayCurrentPages();
          hidePageOverlay();
        });

        gridContainer.appendChild(gridItem);
      });
    }

    // ローディング表示/非表示
    function showLoading() {
      const loading = document.getElementById('loading');
      if (loading) loading.classList.remove('hidden');
    }

    function hideLoading() {
      const loading = document.getElementById('loading');
      if (loading) loading.classList.add('hidden');
    }

    // ページ情報の表示/非表示
    function showPageInfo(autoHide = false, duration = 1000) {
      const pageInfo = document.getElementById('page-info');
      if (pageInfo) {
        pageInfo.style.opacity = '1';

        // 既存のタイマーをクリア
        if (pageInfoTimer) {
          clearTimeout(pageInfoTimer);
          pageInfoTimer = null;
        }

        // autoHideがtrueの場合のみ自動非表示
        if (autoHide) {
          pageInfoTimer = setTimeout(() => {
            pageInfo.style.opacity = '0';
          }, duration);
        }
      }
    }

    function hidePageInfo() {
      const pageInfo = document.getElementById('page-info');
      if (pageInfo) {
        pageInfo.style.opacity = '0';
        if (pageInfoTimer) {
          clearTimeout(pageInfoTimer);
          pageInfoTimer = null;
        }
      }
    }

    // URLパラメータからファイル名を取得
    function getFileFromURL() {
      // #/rootName/path/to/file.cbz 形式を解析
      const hash = window.location.hash;
      if (hash && hash.startsWith('#/')) {
        const fullPath = decodeURIComponent(hash.substring(2));
        const pathParts = fullPath.split('/').filter(p => p);
        if (pathParts.length < 2) return null;

        const rootName = pathParts[0];
        const relativePath = pathParts.slice(1).join('/');
        return { rootName, relativePath };
      }
      return null;
    }

    // CBZファイルの画像リストを取得
    async function loadImageList() {
      try {
        const fileInfo = getFileFromURL();
        console.log('fileInfo:', fileInfo);
        if (!fileInfo || !fileInfo.rootName || !fileInfo.relativePath) {
          throw new Error('ファイルが指定されていません');
        }

        currentFile = `${fileInfo.rootName}/${fileInfo.relativePath}`;

        // ファイル名をツールバーに表示
        const filenameDisplay = document.getElementById('filename-display');
        if (filenameDisplay) {
          const basename = fileInfo.relativePath.split('/').pop();
          filenameDisplay.textContent = basename;
        }

        const response = await fetch(`/api/book/${encodeURIComponent(fileInfo.rootName)}/${fileInfo.relativePath}/list`);
        const data = await response.json();
        console.log('画像リスト:', data);

        if (data.error) {
          throw new Error(data.error);
        }

        images = data.images;
        console.log('画像数:', images.length);

        if (images.length === 0) {
          throw new Error('画像が見つかりません');
        }

        // 保存されたページ位置を復元
        const savedPage = localStorage.getItem(`viewer_page_${currentFile}`);
        const savedOffset = localStorage.getItem(`viewer_offset_${currentFile}`);
        if (savedPage !== null) {
          currentPage = parseInt(savedPage);
          console.log('ページ位置を復元:', currentPage);
        }
        if (savedOffset !== null) {
          offset = parseInt(savedOffset);
          console.log('オフセットを復元:', offset);
        }

        // 最初のページを表示
        await displayCurrentPages(true); // 初回読み込みフラグ
      } catch (err) {
        console.error('loadImageList エラー:', err);
        document.getElementById('page-info').textContent = `エラー: ${err.message}`;
        hideLoading();
      }
    }

    // 画像を読み込み（キャッシュあり）
    async function loadImage(index) {
      if (index < 0 || index >= images.length) {
        return null;
      }

      // キャッシュにあればそれを返す
      if (imageCache[index]) {
        return imageCache[index];
      }

      const url = `/api/book/${encodeURIComponent(currentFile)}/image/${index}`;

      return new Promise((resolve, reject) => {
        const img = new Image();

        img.onload = () => {
          imageCache[index] = img;
          resolve(img);
        };

        img.onerror = () => {
          reject(new Error(`画像 ${index} の読み込みに失敗しました`));
        };

        img.src = url;
      });
    }

    // 画像の横長判定（アスペクト比 >= 1.0）
    function isWideImage(img) {
      return (img.naturalWidth / img.naturalHeight) >= 1.0;
    }

    // ブラウザが縦長かどうかを判定
    function isPortraitViewport() {
      return window.innerHeight > window.innerWidth;
    }

    // オフセットを適用した表示ページを計算
    function getDisplayPage(page = currentPage) {
      const actualPage = (page + offset) % images.length;
      return actualPage < 0 ? images.length + actualPage : actualPage;
    }

    // 現在の表示モードを判定（1ページか見開きか）
    function isForceOnePageMode() {
      return isPortraitViewport() || forceSinglePageMode;
    }

    // 現在のページを表示
    async function displayCurrentPages(isInitialLoad = false) {
      console.log('displayCurrentPages 開始: currentPage=', currentPage, 'offset=', offset);
      showLoading();
      const displayDiv = document.getElementById('image-display');
      const pageInfoDiv = document.getElementById('page-info');

      const displayPage = getDisplayPage();
      console.log('displayPage:', displayPage);

      // ページ位置とオフセットを保存
      localStorage.setItem(`viewer_page_${currentFile}`, currentPage);
      localStorage.setItem(`viewer_offset_${currentFile}`, offset);

      const forceOnePageMode = isForceOnePageMode();

      try {
        // 最初の画像を読み込み
        console.log('画像読み込み開始:', displayPage);
        const img1 = await loadImage(displayPage);
        console.log('画像読み込み完了:', displayPage, img1);

        if (!img1) {
          pageInfoDiv.textContent = 'ページが見つかりません';
          return;
        }

        displayDiv.innerHTML = '';

        // 横長画像の場合、またはブラウザが縦長の場合、または強制1ページモードの場合は1ページのみ表示
        if (isWideImage(img1) || forceOnePageMode) {
          const container = document.createElement('div');
          container.className = 'single-page';

          const imgClone = img1.cloneNode();
          container.appendChild(imgClone);
          displayDiv.appendChild(container);

          if (isWideImage(img1)) {
            pageInfoDiv.textContent = `${displayPage + 1} / ${images.length} (横長)`;
          } else if (forceSinglePageMode) {
            pageInfoDiv.textContent = `${displayPage + 1} / ${images.length} (単ページ)`;
          } else if (isPortraitViewport()) {
            pageInfoDiv.textContent = `${displayPage + 1} / ${images.length} (縦長表示)`;
          } else {
            pageInfoDiv.textContent = `${displayPage + 1} / ${images.length}`;
          }
        } else {
          // 2ページ表示（右綴じ: 右ページ、左ページの順）
          const container = document.createElement('div');
          container.className = 'double-page';

          // 右ページ（現在のページ）
          const rightDiv = document.createElement('div');
          rightDiv.className = 'page page-right';
          const imgClone1 = img1.cloneNode();
          rightDiv.appendChild(imgClone1);

          // 左ページ（次のページ）
          const nextPage = displayPage + 1;
          if (nextPage < images.length) {
            const img2 = await loadImage(nextPage);

            if (img2 && !isWideImage(img2)) {
              const leftDiv = document.createElement('div');
              leftDiv.className = 'page page-left';
              const imgClone2 = img2.cloneNode();
              leftDiv.appendChild(imgClone2);

              container.appendChild(leftDiv);
              container.appendChild(rightDiv);

              pageInfoDiv.textContent = `${displayPage + 1}-${nextPage + 1} / ${images.length}`;
            } else {
              // 次のページが横長の場合は1ページのみ
              container.appendChild(rightDiv);
              pageInfoDiv.textContent = `${displayPage + 1} / ${images.length}`;
            }
          } else {
            // 最後のページ
            container.appendChild(rightDiv);
            pageInfoDiv.textContent = `${displayPage + 1} / ${images.length}`;
          }

          displayDiv.appendChild(container);
        }

        // 前後のページを先読み
        preloadAdjacentPages(displayPage);

        hideLoading();

        // 初回読み込み時のみページ情報を1秒表示
        if (isInitialLoad) {
          showPageInfo(true, 1000);
        }

      } catch (err) {
        pageInfoDiv.textContent = `エラー: ${err.message}`;
        showPageInfo(true, 1000);
        hideLoading();
      }
    }

    // 前後のページを先読み
    async function preloadAdjacentPages(currentIndex) {
      const preloadIndices = [
        currentIndex - 2,
        currentIndex - 1,
        currentIndex + 2,
        currentIndex + 3
      ];

      for (const index of preloadIndices) {
        if (index >= 0 && index < images.length && !imageCache[index]) {
          loadImage(index).catch(() => {
            // エラーは無視（バックグラウンドでの先読みのため）
          });
        }
      }
    }

    // 次のページセットへ移動
    async function nextPages() {
      console.log('nextPages 呼び出し: currentPage=', currentPage);
      const displayPage = getDisplayPage();
      console.log('nextPages: displayPage=', displayPage);

      if (displayPage >= images.length) {
        console.log('最後のページです');
        return;
      }

      const forceOnePageMode = isForceOnePageMode();

      // 画像を読み込んで判定
      console.log('nextPages: 画像判定開始');
      const img = imageCache[displayPage] || await loadImage(displayPage);
      console.log('nextPages: 画像判定完了', img, 'isWide=', isWideImage(img));

      if (forceOnePageMode || (img && isWideImage(img))) {
        currentPage += 1; // 1ページモードまたは横長は1ページ進む
      } else {
        // 次のページもチェック
        const nextPage = displayPage + 1;
        if (nextPage < images.length) {
          const img2 = imageCache[nextPage] || await loadImage(nextPage);
          if (img2 && !isWideImage(img2)) {
            currentPage += 2; // 2ページ進む
          } else {
            currentPage += 1; // 次が横長なら1ページだけ進む
          }
        } else {
          currentPage += 1;
        }
      }

      if (currentPage >= images.length) {
        currentPage = images.length - 1;
      }

      await displayCurrentPages();
    }

    // 前のページセットへ移動
    async function prevPages() {
      const forceOnePageMode = isForceOnePageMode();

      if (forceOnePageMode) {
        currentPage -= 1; // 1ページモードの場合1ページ戻る
      } else {
        currentPage -= 2; // 2ページモードの場合2ページ戻る
      }

      if (currentPage < 0) {
        currentPage = 0;
      }

      await displayCurrentPages();
    }

    // 配置修正: 1ページ進む
    function adjustOffsetForward() {
      offset += 1;
      displayCurrentPages();
    }

    // 配置修正: 1ページ戻る
    function adjustOffsetBackward() {
      offset -= 1;
      displayCurrentPages();
    }

    // 全画面モードの切り替え
    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
          console.error('全画面モードの開始に失敗:', err);
        });
      } else {
        document.exitFullscreen();
      }
    }

    // ファイル一覧に戻る
    function backToList() {
      // sessionStorageをクリアしてブラウザの戻るを使う
      sessionStorage.removeItem('fileListIndex');
      sessionStorage.removeItem('fileListPath');
      history.back();
    }

    // ヘルプの表示/非表示
    function toggleHelp() {
      const help = document.getElementById('help');
      help.style.display = help.style.display === 'none' ? 'flex' : 'none';
    }

    function closeHelp() {
      const help = document.getElementById('help');
      help.style.display = 'none';
    }

    // キーボードイベントハンドラ
    document.addEventListener('keydown', (e) => {
      console.log('キー押下:', e.key);

      switch (e.key) {
        case 'ArrowLeft':
          e.preventDefault();
          nextPages(); // 右綴じなので左キーで次へ
          break;
        case 'ArrowRight':
          e.preventDefault();
          prevPages(); // 右綴じなので右キーで前へ
          break;
        case ' ':
        case 'Spacebar':
          e.preventDefault();
          nextPages(); // スペースキーで次のページ
          break;
        case 'ArrowUp':
          e.preventDefault();
          adjustOffsetBackward();
          break;
        case 'ArrowDown':
          e.preventDefault();
          adjustOffsetForward();
          break;
        case 'Enter':
          e.preventDefault();
          toggleFullscreen();
          break;
        case 's':
        case 'S':
          e.preventDefault();
          forceSinglePageMode = !forceSinglePageMode;
          displayCurrentPages();
          break;
        case 'Escape':
        case 'Backspace':
          e.preventDefault();
          if (document.fullscreenElement) {
            document.exitFullscreen();
          } else {
            backToList();
          }
          break;
        case 'h':
        case 'H':
          e.preventDefault();
          toggleHelp();
          break;
        case 't':
        case 'T':
          e.preventDefault();
          showPageOverlay();
          break;
        case 'l':
        case 'L':
          e.preventDefault();
          togglePageSidebar();
          break;
      }
    });

    // ページ読み込み時に画像リストを取得
    document.addEventListener('DOMContentLoaded', () => {
      // 初期ローディング表示
      showLoading();

      loadImageList();

      // ツールバーのボタンイベント
      setupToolbar();

      // サイドバーのクローズボタン
      document.getElementById('close-sidebar').addEventListener('click', hidePageSidebar);

      // ページ一覧オーバーレイのクローズボタン
      document.getElementById('close-overlay').addEventListener('click', hidePageOverlay);

      // マウスクリックイベント
      setupMouseNavigation();

      // タッチ/スワイプイベント
      setupTouchNavigation();

      // マウス移動でツールバー表示
      setupToolbarVisibility();
    });

    // ツールバーのセットアップ
    function setupToolbar() {
      document.getElementById('btn-back').addEventListener('click', backToList);
      document.getElementById('btn-thumbnails').addEventListener('click', showPageOverlay);
      document.getElementById('btn-list').addEventListener('click', togglePageSidebar);
      document.getElementById('btn-prev').addEventListener('click', prevPages);
      document.getElementById('btn-next').addEventListener('click', nextPages);
      document.getElementById('btn-offset-up').addEventListener('click', adjustOffsetBackward);
      document.getElementById('btn-offset-down').addEventListener('click', adjustOffsetForward);
      document.getElementById('btn-single').addEventListener('click', () => {
        forceSinglePageMode = !forceSinglePageMode;
        displayCurrentPages();
      });
      document.getElementById('btn-fullscreen').addEventListener('click', toggleFullscreen);
      document.getElementById('btn-help').addEventListener('click', toggleHelp);
      document.getElementById('close-help').addEventListener('click', closeHelp);
    }

    // マウスクリックでページ送り
    function setupMouseNavigation() {
      const imageDisplay = document.getElementById('image-display');

      imageDisplay.addEventListener('click', (e) => {
        const rect = imageDisplay.getBoundingClientRect();
        const clickX = e.clientX - rect.left;
        const width = rect.width;

        // 左半分クリックで次へ（右綴じなので左が次）
        if (clickX < width / 2) {
          nextPages();
        } else {
          // 右半分クリックで前へ
          prevPages();
        }
      });
    }

    // タッチ/スワイプでページ送り
    function setupTouchNavigation() {
      const imageDisplay = document.getElementById('image-display');
      let touchStartX = 0;
      let touchStartY = 0;
      let touchEndX = 0;
      let touchEndY = 0;

      imageDisplay.addEventListener('touchstart', (e) => {
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
      }, { passive: true });

      imageDisplay.addEventListener('touchend', (e) => {
        touchEndX = e.changedTouches[0].screenX;
        touchEndY = e.changedTouches[0].screenY;
        handleSwipe();
      }, { passive: true });

      function handleSwipe() {
        const diffX = touchStartX - touchEndX;
        const diffY = touchStartY - touchEndY;
        const minSwipeDistance = 50;

        // 横方向のスワイプが縦方向より大きい場合のみページ送り
        if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > minSwipeDistance) {
          if (diffX < 0) {
            nextPages();
          } else {
            prevPages();
          }
        }
      }
    }

    // ツールバーの表示/非表示制御
    let toolbarTimer;
    function setupToolbarVisibility() {
      const toolbar = document.getElementById('toolbar');
      const viewer = document.getElementById('viewer-container');
      const pageInfo = document.getElementById('page-info');

      viewer.addEventListener('mousemove', (e) => {
        const toolbarHeight = toolbar.offsetHeight;

        // ツールバーの高さ + 余裕（50px）の範囲でツールバー表示
        if (e.clientY < toolbarHeight + 50) {
          toolbar.classList.add('visible');
          clearTimeout(toolbarTimer);
        } else {
          // 範囲外に出たら、ツールバー上でなければすぐに非表示
          if (!toolbar.matches(':hover')) {
            clearTimeout(toolbarTimer);
            toolbar.classList.remove('visible');
          }
        }

        // 画面下部10%にカーソルがある時にページ情報表示
        if (e.clientY > window.innerHeight * 0.9) {
          showPageInfo(false); // 自動非表示なし
        } else {
          hidePageInfo();
        }
      });

      // ツールバー上ではタイマーをキャンセル
      toolbar.addEventListener('mouseenter', () => {
        clearTimeout(toolbarTimer);
      });

      toolbar.addEventListener('mouseleave', () => {
        // ツールバーから離れたらすぐに非表示
        toolbar.classList.remove('visible');
      });
    }

    // ウィンドウリサイズ時に再描画
    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        if (images.length > 0) {
          displayCurrentPages();
        }
      }, 300);
    });
  </script>
</body>

</html>